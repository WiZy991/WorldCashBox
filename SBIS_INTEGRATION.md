# Интеграция с СБИС API для получения актуальных цен

## Настройка

### 1. Переменные окружения

Добавьте в файл `.env.local` или `.env.production` следующие переменные:

```env
# Сервисный ключ СБИС (используется как токен доступа)
SBIS_SERVICE_KEY=JT1lnlaqTJ9ImP7Lhu6SnrDJFO7gQk5mO0tv83wsok4nbzS9ri4VbbvCKVeQIHDoMkwGnSCjMAF04M8pIL5tcH4BzaPsLiNuCijBx8Hp44w13YBWo7I6ID

# ID подключения (для справки, может использоваться в будущем)
SBIS_CONNECTION_ID=0448926307017312

# Защищенный ключ (для справки, может использоваться в будущем)
SBIS_SECRET_KEY=4C13R3KFAGFF9V6ZRD2AWYUD

# ID точки продаж в СБИС
SBIS_POINT_ID=206

# ID прайс-листа в СБИС (опционально, если не указан, будет использован первый доступный)
SBIS_PRICE_LIST_ID=15

# ID склада в СБИС (UUID, опционально - если не указан, будет автоматически выбран первый доступный склад)
SBIS_WAREHOUSE_ID=284a42ba-97cc-4d9c-98af-00000000100a

# Название склада для автоматического выбора (опционально, если не указан ID склада)
SBIS_WAREHOUSE_NAME=Склад32
```

### 2. Учетные данные

Сервисный ключ используется напрямую как токен доступа (`X-SBISAccessToken`) в заголовках запросов к API СБИС.

### 3. Получение ID точки продаж

ID точки продаж (`pointId`) можно получить через API СБИС "Получить точку продаж" или в настройках вашей точки продаж в СБИС.

## Использование

### Синхронизация цен через админ-панель

1. Откройте админ-панель: `/admin/products`
2. Нажмите кнопку **"Синхронизировать цены"**
3. Система автоматически:
   - Получит список прайс-листов (если не указан `SBIS_PRICE_LIST_ID`)
   - Загрузит все цены из выбранного прайс-листа
   - Обновит цены товаров, у которых указан `sbisId`

### Синхронизация цен и остатков через API

```bash
# POST запрос к API
curl -X POST http://localhost:3000/api/sbis/prices/sync \
  -H "Content-Type: application/json" \
  -d '{
    "pointId": 206,
    "priceListId": 15,
    "warehouseId": "284a42ba-97cc-4d9c-98af-00000000100a",
    "force": false,
    "syncStock": true
  }'
```

**Параметры:**
- `pointId` - ID точки продаж (опционально, если указан в env)
- `priceListId` - ID прайс-листа (опционально, если указан в env)
- `warehouseId` - ID склада в СБИС (UUID, опционально, если указан в env)
- `force` - Принудительное обновление всех товаров (по умолчанию: false)
- `syncStock` - Синхронизировать остатки (по умолчанию: true)

### Связывание товаров с СБИС

1. Откройте товар для редактирования в админ-панели
2. В поле **"ID товара в СБИС (артикул)"** укажите:
   - ID товара из СБИС
   - Артикул товара
   - Название товара (для поиска по названию)
3. В поле **"ID склада в СБИС"** укажите UUID склада (опционально, если не указан, используется из настроек)
4. Сохраните товар
5. При синхронизации система найдет товар в СБИС и обновит цену и остатки

### Проверка склада

В админ-панели есть кнопка **"Проверить склад"**, которая позволяет проверить существование склада в СБИС по его ID.

### Автоматическая синхронизация

Для автоматической синхронизации цен можно настроить cron-задачу:

```bash
# Пример cron задачи (синхронизация каждый час)
0 * * * * curl -X POST https://your-domain.com/api/sbis/prices/sync
```

Или использовать планировщик задач вашего хостинга.

## API Endpoints

### GET /api/sbis/warehouse/list

Получить список всех складов из СБИС.

**Query параметры:**
- `preferredName` - Предпочтительное название склада (опционально)

**Пример:**
```bash
GET /api/sbis/warehouse/list
GET /api/sbis/warehouse/list?preferredName=Склад32
```

**Ответ:**
```json
{
  "success": true,
  "warehouses": [
    {
      "id": "284a42ba-97cc-4d9c-98af-00000000100a",
      "name": "Склад32",
      "code": null,
      "address": null,
      "organization": {
        "inn": "4804948184",
        "kpp": "480494818",
        "branchCode": null
      }
    }
  ],
  "count": 1
}
```

### GET /api/sbis/warehouse/read

Получить информацию о складе из СБИС.

**Query параметры:**
- `id` - UUID склада
- `name` - Название склада
- `code` - Код склада

**Пример:**
```bash
GET /api/sbis/warehouse/read?id=284a42ba-97cc-4d9c-98af-00000000100a
```

**Ответ:**
```json
{
  "success": true,
  "warehouse": {
    "id": "284a42ba-97cc-4d9c-98af-00000000100a",
    "name": "Склад32",
    "code": null,
    "address": null,
    "organization": {
      "inn": "4804948184",
      "kpp": "480494818",
      "branchCode": null
    }
  }
}
```

### POST /api/sbis/warehouse/read

Получить информацию о складе из СБИС (POST запрос).

**Тело запроса:**
```json
{
  "id": "284a42ba-97cc-4d9c-98af-00000000100a",
  "name": "Склад32",
  "code": "WH001",
  "organization": {
    "inn": "4804948184",
    "kpp": "480494818",
    "branchCode": "001"
  }
}
```

**Примечание:** Для поиска склада необходимо указать хотя бы один параметр: `id`, `name`, `code` или `organization`.

### GET /api/sbis/prices/sync

Получить статус синхронизации цен.

**Ответ:**
```json
{
  "total": 150,
  "withPrices": 120,
  "withStock": 100,
  "inStock": 85,
  "withSBISId": 80,
  "recentlyUpdated": 45,
  "lastSync": "2025-01-27T12:00:00.000Z"
}
```

### POST /api/sbis/prices/sync

Синхронизировать цены из СБИС.

**Тело запроса (опционально):**
```json
{
  "pointId": 206,
  "priceListId": 15,
  "force": false
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Цены и остатки успешно синхронизированы",
  "stats": {
    "total": 150,
    "pricesUpdated": 45,
    "stockUpdated": 38,
    "notFound": 5,
    "priceListId": 15,
    "warehouseId": "284a42ba-97cc-4d9c-98af-00000000100a",
    "syncedAt": "2025-01-27T12:00:00.000Z"
  }
}
```

## Структура данных

### Product (расширенный интерфейс)

```typescript
interface Product {
  // ... существующие поля ...
  
  // Поля для интеграции с СБИС
  sbisId?: string | number;        // ID товара в СБИС
  sbisPriceListId?: number;        // ID прайс-листа
  priceUpdatedAt?: string;         // Дата последнего обновления цены
  stock?: number;                  // Количество товара на складе
  inStock?: boolean;               // Наличие товара (true если stock > 0)
  stockUpdatedAt?: string;         // Дата последнего обновления остатков
  sbisWarehouseId?: string;         // ID склада в СБИС (UUID)
}
```

## Примечания

1. **Поиск товаров**: Система ищет товары в СБИС по:
   - Точному совпадению `sbisId`
   - Частичному совпадению названия товара

2. **Обновление цен**: Цены обновляются только если:
   - У товара указан `sbisId`
   - Товар найден в прайс-листе СБИС
   - Новая цена отличается от текущей

3. **Обновление остатков**: Остатки обновляются только если:
   - У товара указан `sbisId`
   - Указан `SBIS_WAREHOUSE_ID` (в env или в товаре)
   - Товар найден на складе в СБИС
   - Новое количество отличается от текущего

4. **Статус наличия**: Поле `inStock` автоматически устанавливается в `true`, если `stock > 0`, иначе `false`.

5. **Ошибки**: Если товар не найден в СБИС, его цена и остатки не обновляются, но товар не удаляется.

6. **Производительность**: При большом количестве товаров синхронизация может занять некоторое время. Рекомендуется выполнять её в фоновом режиме.

7. **Автоматическая синхронизация**: Для автоматической синхронизации можно настроить cron-задачу:
   ```bash
   # Синхронизация каждый час
   0 * * * * curl -X POST https://your-domain.com/api/sbis/prices/sync
   ```

## Устранение проблем

### Ошибка: "SBIS_ACCESS_TOKEN не настроен"
- Проверьте, что переменная окружения `SBIS_ACCESS_TOKEN` установлена
- Перезапустите сервер после изменения переменных окружения

### Ошибка: "SBIS_POINT_ID не настроен"
- Укажите `pointId` в запросе или в переменных окружения
- Проверьте правильность ID точки продаж

### Товары не обновляются
- Убедитесь, что у товаров указан `sbisId`
- Проверьте, что товары существуют в прайс-листе СБИС
- Проверьте логи сервера на наличие ошибок API

### Неверные цены
- Проверьте, что используется правильный прайс-лист
- Убедитесь, что дата `actualDate` актуальна
- Проверьте соответствие `sbisId` товаров
